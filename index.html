<html>
<head>
<meta name="google-site-verification"
    content="772SnMSyIMzcGQJ_74cYZEQB2CZKswi0L0cvhWhV4cc" />
<link
    href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css"
    rel="stylesheet" type="text/css" />
<script
    src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script
    src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="http://jmat.googlecode.com/git/jmat.js"></script>
<script src="imagejs.js"></script>
<link rel="stylesheet" type="text/css" href="imagejs.css">
</head>
<body onload="imagejs.start()">
    <div id="menu"></div>
    <div id="msg">drag png, jpeg or gif image in the box to start:</div>
    <div id="work">
        <canvas id="cvBase" style="border: solid 1px">sorry, your browser does not support HTML5</canvas>
        <div id="manualUPL">
            or <input type="file" id="work2" name="work2" value="Upload File">
        </div>
        <div id="foot"></div>
    </div>
    <br/>
    Upload previously downloaded file
    <br/>
    <input type="file" value="Upload File">
    <script>
        // based on http://www.html5rocks.com/en/tutorials/file/dndfiles/
        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            imagejs.readImage(evt.dataTransfer.files);
        }

        function manualFileSelect(evt) {
            var files = evt.target.files;
            imagejs.readImage(files);
        }

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        }
        function manualFileSelect(evt) {
            var files = evt.target.files;
            imagejs.readImage(files);
        }

        function handleJSONUpload(evt) {
            var files = evt.target.files;
            if(files){
             file = files[0];
            var reader = new FileReader();
            reader.onload = loaded;
            reader.readAsText(file);
            }
        }
        function loaded1(evt) { //Renamed the original function to loaded1
            var compressedText = evt.target.result; //1,22,33,44,55
            //Convert comma-separated text content to Array
            var textArray = compressedText.split(',') //['1','22','33','44','55']  
            //LZW algorithm's decompress function need compressed text as Int Array. Converting textArray to Int Array
            //[1,22,33,44,55]
            var intArray = [];
            for ( var i = 0; i < textArray.length; i++) {
                intArray[i] = parseInt(textArray[i])
            }
            var jsonText = LZW.decompress(intArray)
            console.log('Decompressed Successfully')
            //Create JSON Object from JSON Text //Reverse of JSON.Stringify
            var jsonObj = eval('(' + jsonText + ')');  // jsonObj == imagejs.data      
            //Resize Canvas
            var s = jmat.size(jsonObj.img);
            var cvBase = document.getElementById('cvBase')
            cvBase.height = s[0];
            cvBase.width = s[1];
            //Write actual image(imagejs.data.img or jsonObj.img)
            jmat.imwrite(cvBase, jsonObj.img)
            //Write Highlighting stuff.(imagejs.data.seg or jsonObj.seg) Convert jsonObj.seg ?
            //Convert jsonObj.seg to have RGB values.
           
             // jmat.imagebw(cvBase,jmat.edge(jsonObj.seg),[0,0,0,0],[255,255,0,255])
             
            var cvTop=document.createElement('canvas');
            cvTop.id='cvTop';
            cvTop.width=cvBase.width;
            cvTop.height=cvBase.height;
            cvTop.style.position='absolute';
            cvTop.style.left=cvBase.offsetLeft;cvTop.style.top=cvBase.offsetTop;
            jmat.imagebw(cvTop,jmat.edge(jsonObj.seg),[0,0,0,0],[255,255,0,255])
           
            //document.getElementById('cvBase').getContext('2d').drawImage(document.getElementById('cvTop'),0,0);
            document.getElementById('cvBase1').getContext('2d').drawImage(cvTop,0,0);       
        }
        function loaded(evt) {
        	var text = evt.target.result;
        	var seperator = text.indexOf('ZZZZZZZ'); 
        	var imageText = text.substring(0, seperator);
        	var segText = text.substring(seperator + 7);
        	
        	var textArray = segText.split(',');
            var intArray = [];
            for ( var i = 0; i < textArray.length; i++) {
                intArray[i] = parseInt(textArray[i])
            }
            var decompressedSegText = LZW.decompress(intArray);
        	
        	var im = new Image();
        	im.onload=function() {
        		//Write image to base Canvas
        		var cvBase=document.getElementById('cvBase');
        		cvBase.width=this.width;cvBase.height=this.height; //size canvas to the image
        		var ctx=cvBase.getContext('2d');
        		ctx.drawImage(this,0,0);
        		
        		//Creat a canvas with segmentation data, and write that canvas to base canvas
        		var jsonObj = eval('({ seg: ' + decompressedSegText + '})'); 
        		var cvTop=document.createElement('canvas');
                cvTop.id='cvTop';
                cvTop.width=cvBase.width;
                cvTop.height=cvBase.height;
                cvTop.style.position='absolute';
                cvTop.style.left=cvBase.offsetLeft;cvTop.style.top=cvBase.offsetTop;
                jmat.imagebw(cvTop,jmat.edge(jsonObj.seg),[0,0,0,0],[255,255,0,255])
                ctx.drawImage(cvTop,0,0);   
        	} 
        	im.src=imageText; 
            
         }



        
       
        // Setup the dnd/manual listeners.
        var dropZone = document.getElementById('work');
        var manualSel = document.getElementById('work2');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
        manualSel.addEventListener('change', manualFileSelect, false);
        addEventListener('change', handleJSONUpload, false);

        
    </script>

</body>
</html>